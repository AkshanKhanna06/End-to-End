import jenkins.model.*
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*

pipeline {
    agent any

    parameters {
        credentials(name: 'DOCKER_CREDENTIALS', description: 'Select Docker Hub credentials (optional, auto-detected if empty)', required: false)
    }

    environment {
        DOCKER_IMAGE     = "akkicasm06/cloud-native-test-app"
        IMAGE_TAG        = "${env.BUILD_ID}"
        HELM_CHART_PATH  = "helm/app-chart"
        NAMESPACE        = "observability"
    }

    stages {

        stage('1. Code Checkout') {
            steps {
                echo "Code checkout done."
            }
        }

        stage('2. Build Image') {
            steps {
                dir('test-app') {
                    bat "docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} ."
                }
            }
        }

        stage('3. Push Image to Docker Hub') {
            steps {
                script {
                    // --- AUTO-DETECT DOCKER CREDENTIALS ---
                    def dockerCred = params.DOCKER_CREDENTIALS
                    if (!dockerCred) {
                        def creds = Jenkins.instance
                            .getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0]
                            .getCredentials()
                        def match = creds.find { it.description?.toLowerCase()?.contains('docker') || it.id?.toLowerCase()?.contains('docker') }
                        dockerCred = match?.id
                        if (!dockerCred) {
                            error "‚ùå No Docker credentials found in Jenkins. Please add or select one."
                        } else {
                            echo "‚úÖ Auto-detected Docker credentials: ${dockerCred}"
                        }
                    }

                    // --- USE CREDENTIALS SECURELY ---
                    withCredentials([usernamePassword(
                        credentialsId: dockerCred,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        echo "üîê Logging in to Docker Hub..."
                        bat "docker login -u %DOCKER_USER% -p %DOCKER_PASS%"
                        echo "üì¶ Pushing image to Docker Hub..."
                        bat "docker push ${DOCKER_IMAGE}:${IMAGE_TAG}"
                    }
                }
            }
        }

        stage('4. Helm Lint') {
            steps {
                dir('helm/app-chart') {
                    bat "helm lint ."
                }
            }
        }

        stage('5. Deploy Observability & App (ELK Stack)') {
            steps {
                withEnv(['KUBECONFIG=C:\\Users\\aksha\\.kube\\config']) {
                    echo "--- Ensuring Namespace ---"
                    bat "kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -"

                    echo "--- Adding Helm Repositories ---"
                    bat "helm repo add elastic https://helm.elastic.co --force-update"
                    bat "helm repo add bitnami https://charts.bitnami.com/bitnami --force-update"
                    bat "helm repo add grafana https://grafana.github.io/helm-charts --force-update"
                    bat "helm repo update"

                    echo "--- Deploying Elasticsearch ---"
                    bat """
                    helm upgrade --install elasticsearch elastic/elasticsearch ^
                    -f helm/observability/elasticsearch-values.yaml ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 10m
                    """

                    echo "--- Deploying Fluentd ---"
                    bat """
                    helm upgrade --install fluentd bitnami/fluentd ^
                    -f helm/observability/fluentd-values.yaml ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 5m
                    """

                    echo "--- Deploying Kibana ---"
                    bat """
                    helm upgrade --install kibana elastic/kibana ^
                    -f helm/observability/kibana-values.yaml ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 5m
                    """

                    echo "--- Deploying Grafana (optional metrics) ---"
                    bat """
                    helm upgrade --install grafana grafana/grafana ^
                    -f helm/observability/grafana-values.yaml ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 5m
                    """

                    echo "--- Deploying Application ---"
                    bat """
                    helm upgrade --install test-app-release ${HELM_CHART_PATH} ^
                    --set image.repository=${DOCKER_IMAGE} ^
                    --set image.tag=${IMAGE_TAG} ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 5m
                    """

                    echo "--- ‚úÖ Deployment Complete. Checking Pods ---"
                    bat "kubectl get pods -n ${NAMESPACE}"
                }
            }
        }
    }
}
