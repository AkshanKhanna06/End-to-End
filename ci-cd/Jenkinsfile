pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "akkicasm06/cloud-native-test-app"
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        COMPOSE_PATH = "compose"
    }

    stages {
        stage('1. Checkout') {
            steps {
                echo "‚úÖ Checking out code"
            }
        }

        stage('2. Build Docker Image') {
            steps {
                dir('test-app') {
                    bat "docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} ."
                }
            }
        }

        stage('3. Push to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-hub-creds', 
                                                 usernameVariable: 'DOCKER_USER',
                                                 passwordVariable: 'DOCKER_PASS')]) {
                    echo "üîê Logging into Docker Hub..."
                    bat "echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin"
                    bat "docker push ${DOCKER_IMAGE}:${IMAGE_TAG}"
                    bat "docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_IMAGE}:latest"
                    bat "docker push ${DOCKER_IMAGE}:latest"
                }
            }
        }

        stage('4. Deploy via Docker Compose') {
            steps {
                dir("${COMPOSE_PATH}") {
                    echo "üöÄ Starting Observability Stack + App..."
                    bat "docker compose down || echo nothing_to_down"
                    bat "docker compose up -d"
                }
            }
        }

        stage('5. Verify Containers') {
            steps {
                bat "docker ps"
                echo """
‚úÖ Deployment complete.

Access:
- App:        http://localhost:8080
- Kibana:     http://localhost:5601
- Grafana:    http://localhost:3000
"""
            }
        }

        stage('6. Optional Cleanup') {
            steps {
                input message: 'Do you want to stop all containers?', ok: 'Yes, Clean Up'
                dir("${COMPOSE_PATH}") {
                    bat "docker compose down"
                }
                echo "üßπ Containers stopped and cleaned up."
            }
        }
    }

    post {
        always {
            echo "üèÅ Pipeline finished."
        }
    }
}
