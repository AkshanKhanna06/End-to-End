pipeline {
    agent any

    parameters {
        // I've kept CLEANUP but modified Stage 6 to always run after the wait.
        booleanParam(name: 'CLEANUP', defaultValue: false, description: 'Stop and remove containers after build')
    }

    environment {
        IMAGE_NAME   = "akkicasm06/cloud-native-test-app"
        COMPOSE_PATH = "compose"
    }

    stages {
        stage('1. Checkout') {
            steps {
                checkout scm
                echo "‚úÖ Code checked out from repository"
            }
        }

        stage('2. Build Application Image') {
            steps {
                dir('test-app') {
                    echo "üß© Building Docker image for the app..."
                    bat "docker build -t ${IMAGE_NAME}:latest ."
                }
            }
        }

        stage('3. Start Observability Stack') {
            steps {
                dir("${COMPOSE_PATH}") {
                    echo "üöÄ Launching Observability Stack via Docker Compose..."
                    // Stop any old stack cleanly
                    bat "docker compose down || echo 'No previous stack found'"
                    // Bring everything up
                    bat "docker compose up -d --build"
                }
            }
        }

        stage('4. Open Application & Dashboards') {
            steps {
                script {
                    echo "üîç Checking running containers and opening dashboards..."
                    bat 'docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"' // Combined verification
                    
                    // Opening the URLs (Note: 'start' command is Windows-specific/interactive)
                    bat """
                    start http://localhost:8085
                    start http://localhost:3000
                    start http://localhost:5601
                    """
                    echo """
                    ‚úÖ Application:  http://localhost:8085
                    üìä Grafana:      http://localhost:3000 (admin / admin)
                    üß© Kibana:       http://localhost:5601
                    """
                }
            }
        }
        
        // üåü NEW STAGE: Waits for 15 minutes before proceeding
        stage('5. Wait for Testing (15 mins)') {
            steps {
                script {
                    echo "‚è≥ Stack is running for 15 minutes. Check application and dashboards now."
                    
                    // Use timeout to run a long action. This ensures Jenkins doesn't hang forever.
                    timeout(time: 15, unit: 'MINUTES') {
                        // sleep command pauses the execution for 900 seconds (15 minutes)
                        sleep(900)
                    }
                    
                    echo "‚è± 15 minutes passed. Proceeding to cleanup."
                }
            }
        }

        // üåü MODIFIED STAGE: Renamed and modified to run automatically
        stage('6. Automatic Cleanup') {
            steps {
                dir("${COMPOSE_PATH}") {
                    echo "üßπ Automatically cleaning up stack..."
                    // The -v flag ensures volumes are removed, which is a thorough cleanup.
                    bat "docker compose down -v"
                }
            }
        }
    }

    post {
        always {
            echo "üèÅ Pipeline finished. All resources have been cleaned up."
        }
    }
}