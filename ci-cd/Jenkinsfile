import jenkins.model.*
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*

pipeline {
    agent any

    parameters {
        credentials(name: 'DOCKER_CREDENTIALS', description: 'Select Docker Hub credentials (optional, auto-detected if empty)', required: false)
    }

    environment {
        IMAGE_TAG        = "${env.BUILD_ID}"
        HELM_CHART_PATH  = "helm/app-chart"
        NAMESPACE        = "observability"
        KUBECONFIG_PATH  = "C:\\Users\\aksha\\.kube\\config"
    }

    stages {

        stage('1. Code Checkout') {
            steps {
                echo "‚úÖ Code checkout done."
            }
        }

        stage('2. Build & Push Dynamic Docker Image') {
            steps {
                script {
                    // --- AUTO-DETECT DOCKER CREDENTIAL ---
                    def dockerCred = params.DOCKER_CREDENTIALS
                    if (!dockerCred) {
                        def creds = Jenkins.instance
                            .getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0]
                            .getCredentials()
                        def match = creds.find { it.description?.toLowerCase()?.contains('docker') || it.id?.toLowerCase()?.contains('docker') }
                        dockerCred = match?.id
                        if (!dockerCred) {
                            error "‚ùå No Docker credentials found in Jenkins. Please add or select one."
                        } else {
                            echo "‚úÖ Auto-detected Docker credentials: ${dockerCred}"
                        }
                    }

                    // --- USE THOSE CREDENTIALS ---
                    withCredentials([usernamePassword(
                        credentialsId: dockerCred,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {

                        def dynamicImage = "${DOCKER_USER}/cloud-native-test-app"
                        echo "üß© Using dynamic image repository: ${dynamicImage}"

                        dir('test-app') {
                            bat "docker build -t ${dynamicImage}:${IMAGE_TAG} ."
                        }

                        bat "echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin"

                        echo "üì¶ Ensuring repository exists..."
                        bat """
                        curl -u %DOCKER_USER%:%DOCKER_PASS% ^
                          -H "Content-Type: application/json" ^
                          -X POST ^
                          -d "{\\"name\\": \\"cloud-native-test-app\\", \\"is_private\\": false}" ^
                          https://hub.docker.com/v2/repositories/%DOCKER_USER%/
                        """

                        echo "üöÄ Pushing image to Docker Hub..."
                        bat "docker push ${dynamicImage}:${IMAGE_TAG}"

                        env.DOCKER_IMAGE = dynamicImage
                    }
                }
            }
        }

        stage('3. Helm Lint') {
            steps {
                dir('helm/app-chart') {
                    bat "helm lint ."
                }
            }
        }

        stage('4. Deploy Observability & App (ELK Stack)') {
            when {
                expression { fileExists(env.KUBECONFIG_PATH) && bat(returnStatus: true, script: 'where kubectl') == 0 }
            }
            steps {
                withEnv(["KUBECONFIG=${env.KUBECONFIG_PATH}"]) {
                    echo "--- Ensuring Namespace ---"
                    bat "kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f - --validate=false"

                    echo "--- Adding Helm Repositories ---"
                    bat "helm repo add elastic https://helm.elastic.co --force-update"
                    bat "helm repo add bitnami https://charts.bitnami.com/bitnami --force-update"
                    bat "helm repo add grafana https://grafana.github.io/helm-charts --force-update"
                    bat "helm repo update"

                    echo "--- Deploying Elasticsearch ---"
                    bat """
                    helm upgrade --install elasticsearch elastic/elasticsearch ^
                    -f helm/observability/elasticsearch-values.yaml ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 10m
                    """

                    echo "--- Deploying Fluentd ---"
                    bat """
                    helm upgrade --install fluentd bitnami/fluentd ^
                    -f helm/observability/fluentd-values.yaml ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 5m
                    """

                    echo "--- Deploying Kibana ---"
                    bat """
                    helm upgrade --install kibana elastic/kibana ^
                    -f helm/observability/kibana-values.yaml ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 5m
                    """

                    echo "--- Deploying Grafana (optional metrics) ---"
                    bat """
                    helm upgrade --install grafana grafana/grafana ^
                    -f helm/observability/grafana-values.yaml ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 5m
                    """

                    echo "--- Deploying Application ---"
                    bat """
                    helm upgrade --install test-app-release ${HELM_CHART_PATH} ^
                    --set image.repository=${env.DOCKER_IMAGE} ^
                    --set image.tag=${IMAGE_TAG} ^
                    -n ${NAMESPACE} ^
                    --wait --timeout 5m
                    """

                    echo "--- ‚úÖ Deployment Complete. Checking Pods ---"
                    bat "kubectl get pods -n ${NAMESPACE}"
                }
            }
            post {
                unsuccessful {
                    echo "‚ö†Ô∏è Deployment skipped or failed ‚Äî cluster not configured or kubectl missing."
                }
            }
        }
    }

    post {
        always {
            echo "üèÅ Pipeline finished."
        }
    }
}
